<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ‰‹æ©Ÿç§Ÿå€Ÿé ç´„</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    :root{
      --bg:#f7f7f9; --card:#fff; --text:#111; --muted:#667; --accent:#0a58ff;
      --border:#e6e6ef; --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,"PingFang TC","Noto Sans TC",system-ui,sans-serif;
      background:var(--bg); color:var(--text); margin:0; padding:28px}
    .container{max-width:720px; margin-inline:auto; background:var(--card); border:1px solid var(--border); border-radius:20px; padding:24px 20px 28px}
    h1{margin:0 0 18px; text-align:center; font-size:24px}
    .row{margin-top:16px}
    label{font-weight:700; display:block; margin-bottom:8px}
    .control{width:100%; border:1px solid var(--border); border-radius:10px; padding:12px; font-size:16px; background:#fff}
    textarea.control{min-height:100px; resize:vertical}
    .grid{display:grid; gap:12px}
    @media (min-width:640px){ .grid-2{grid-template-columns:1fr 1fr} }
    .hint{font-size:13px; color:var(--muted); margin-top:6px}
    .summary{margin-top:10px; border:1px solid #dfe7ff; background:#eef3ff; color:#173b8e; border-radius:10px; padding:12px; line-height:1.7}
    .summary b{font-weight:800}
    .price{margin-top:10px; border:1px dashed #ccc; background:#fafafa; border-radius:10px; padding:12px; color:#333}
    .actions{margin-top:22px}
    button{width:100%; padding:14px 18px; border:none; color:#fff; background:var(--accent); border-radius:12px; font-size:16px; cursor:pointer}
    button[disabled]{opacity:.65; cursor:not-allowed}
    .checkbox{display:flex; align-items:center; gap:10px}
    .checkbox input{width:18px; height:18px; margin:0; accent-color:var(--accent)}
    .req{color:#d00; font-weight:700; margin-left:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± æ‰‹æ©Ÿç§Ÿå€Ÿé ç´„</h1>

    <form id="rentalForm" novalidate autocomplete="off">
      <!-- å§“å / é›»è©± -->
      <div class="grid grid-2">
        <div class="row">
          <label>å§“å <span class="req">ï¼ˆå¿…å¡«ï¼‰</span></label>
          <input class="control" type="text" name="name" required>
        </div>
        <div class="row">
          <label>é›»è©± <span class="req">ï¼ˆå¿…å¡«ï¼‰</span></label>
          <input class="control" type="tel" name="phone" required pattern="^[0-9 +()\\-]{6,}$" placeholder="09xxâ€¦ æˆ–å¯å« + - ( ) ç©ºç™½">
        </div>
      </div>

      <!-- ç§Ÿå€Ÿæ—¥æœŸï¼ˆå€é–“ï¼‰ -->
      <div class="row">
        <label>ç§Ÿå€Ÿæ—¥æœŸï¼ˆå€é–“ï¼‰ <span class="req">ï¼ˆå¿…å¡«ï¼‰</span></label>
        <input class="control" type="text" id="daterange" name="daterange" required placeholder="è«‹é¸æ“‡æ—¥æœŸå€é–“">
        <div id="dateSummary" class="summary" style="display:none"></div>
      </div>

      <!-- è¨­å‚™ -->
      <div class="row">
        <label>ç§Ÿå€Ÿè¨­å‚™ <span class="req">ï¼ˆå¿…å¡«ï¼‰</span></label>
        <select class="control" id="device" name="device" required>
          <option value="" disabled selected>è«‹é¸æ“‡</option>
          <option value="S23 Ultra é»‘">S23 Ultra é»‘</option>
          <option value="iPhone 14 Pro">iPhone 14 Pro</option>
          <option value="Z Flip 5">Z Flip 5</option>
        </select>
      </div>

      <!-- å……é›»å™¨ -->
      <div class="row">
        <label>åŠ å€¼é…ä»¶</label>
        <label class="checkbox">
          <input type="checkbox" id="charger" name="charger">
          <span>éœ€è¦ Type-C å……é›»é ­</span>
        </label>
        <div class="hint">ï¼ˆå……é›»é ­ä¸åŠ åƒ¹ï¼›å¦‚éœ€åŠ åƒ¹è¦å‰‡å¯å†è£œï¼‰</div>
      </div>

      <!-- ä»˜æ¬¾å¹£åˆ¥ï¼ˆæ–°å¢ï¼‰ -->
      <div class="row">
        <label>ä»˜æ¬¾å¹£åˆ¥ <span class="req">ï¼ˆå¿…é¸ï¼‰</span></label>
        <select class="control" id="currency" name="currency" required>
          <option value="" disabled selected>è«‹é¸æ“‡</option>
          <option value="TWD">å°å¹£ï¼ˆTWDï¼‰</option>
          <option value="KRW">éŸ“å¹£ï¼ˆKRWï¼‰</option>
        </select>
        <!-- é ä¼°é‡‘é¡é¡¯ç¤ºï¼Œç§»åˆ°å¹£åˆ¥ä¸‹æ–¹ -->
        <div id="priceBox" class="price" style="display:none"></div>
        <div class="hint">è²»ç‡ï¼šå°å¹£ 1â€“2 å¤© $700ï¼å¤©ã€3â€“4 å¤© $650ï¼å¤©ã€5+ å¤© $650ï¼å¤©ï¼›éŸ“å¹£ 1â€“2 å¤© â‚©30,000ï¼å¤©ã€3â€“4 å¤© â‚©32,000ï¼å¤©ã€5+ å¤© â‚©32,000ï¼å¤©ã€‚</div>
      </div>

      <!-- è¯çµ¡æ–¹å¼ï¼ˆIG / LINE åˆ†é–‹ï¼‰ -->
      <div class="grid grid-2">
        <div class="row">
          <label>IG å¸³è™Ÿ</label>
          <input class="control" type="text" name="ig" placeholder="é¸å¡«">
        </div>
        <div class="row">
          <label>LINE ID</label>
          <input class="control" type="text" name="line" placeholder="é¸å¡«">
        </div>
      </div>

      <!-- å–æ©Ÿåœ°é» -->
      <div class="row">
        <label>é è¨ˆå–æ©Ÿåœ°é» <span class="req">ï¼ˆå¿…å¡«ï¼‰</span></label>
        <select class="control" name="pickup" required>
          <option value="" disabled selected>è«‹é¸æ“‡</option>
          <option>å¼˜å¤§</option>
          <option>æ–°æ‘</option>
          <option>åˆäº•</option>
          <option>æœ›é </option>
        </select>
      </div>

      <!-- å‚™è¨» -->
      <div class="row">
        <label>å‚™è¨»</label>
        <textarea class="control" name="note" placeholder="å…¶ä»–éœ€æ±‚å¯è£œå……ï¼ˆé¸å¡«ï¼‰"></textarea>
      </div>

      <!-- åŒæ„æ¢æ¬¾ -->
      <div class="row checkbox">
        <input type="checkbox" id="agree" name="agree" required>
        <label for="agree" style="margin:0">æˆ‘å·²é–±è®€ä¸¦åŒæ„ç§Ÿå€Ÿæ¢æ¬¾ <span class="req">ï¼ˆå¿…å‹¾ï¼‰</span></label>
      </div>

      <!-- é€å‡º -->
      <div class="actions">
        <button id="submitBtn" type="submit">é€å‡ºé ç´„</button>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // ====== å¾Œç«¯ APIï¼ˆå¡«äº†å°±æœƒæŠ“ä¸å¯é ç´„æ—¥æœŸ + å¯é€å‡ºï¼‰======
    const ENDPOINT = ""; // ä¾‹ï¼š'https://script.google.com/macros/s/xxxx/exec'

    // ====== åƒ¹æ ¼è¡¨ï¼ˆå¯é‡å°æ©Ÿç¨®åˆ†åƒ¹ï¼‰======
    // å‚³å…¥å¤©æ•¸å›å‚³ã€Œæ¯æ—¥åƒ¹æ ¼ã€
    const PRICE_TWD = {
      "S23 Ultra é»‘": d => d <= 2 ? 700 : (d <= 4 ? 650 : 650),
      "iPhone 14 Pro": d => d <= 2 ? 700 : (d <= 4 ? 650 : 650),
      "Z Flip 5":     d => d <= 2 ? 700 : (d <= 4 ? 650 : 650),
      "_default":     d => d <= 2 ? 700 : (d <= 4 ? 650 : 650)
    };
    const PRICE_KRW = {
      "S23 Ultra é»‘": d => d <= 2 ? 30000 : (d <= 4 ? 32000 : 32000),
      "iPhone 14 Pro": d => d <= 2 ? 30000 : (d <= 4 ? 32000 : 32000),
      "Z Flip 5":     d => d <= 2 ? 30000 : (d <= 4 ? 32000 : 32000),
      "_default":     d => d <= 2 ? 30000 : (d <= 4 ? 32000 : 32000)
    };

    // ====== å·¥å…· ======
    const $ = s => document.querySelector(s);
    const weekday = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    const toYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const toHuman = d => `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}ï¼ˆ${weekday[d.getDay()]}ï¼‰`;

    const dateSummary = $("#dateSummary");
    const priceBox = $("#priceBox");

    let selectedDays = 0;

    // ====== å–å¾— & è™•ç†ä¸å¯é ç´„æ—¥æœŸ ======
    function expandRangesToDates(ranges){
      // å°‡ [{start,end}] è½‰ç‚º ["yyyy-mm-dd", ...]
      const out = [];
      ranges.forEach(r=>{
        const s = new Date(r.start), e = new Date(r.end);
        const cur = new Date(s.getFullYear(), s.getMonth(), s.getDate());
        const last = new Date(e.getFullYear(), e.getMonth(), e.getDate());
        while (cur <= last) {
          out.push(toYMD(cur));
          cur.setDate(cur.getDate()+1);
        }
      });
      return out;
    }

    let disabledDates = []; // ["yyyy-mm-dd", ...]
    async function loadDisabledDates(){
      if(!ENDPOINT) return; // æœªå¡«å‰‡ç•¥é
      try{
        const r = await fetch(`${ENDPOINT}?action=reserved`, {cache:"no-store"});
        const data = await r.json();
        if(Array.isArray(data)){
          // å¯èƒ½æ˜¯ [{start,end}, ...]
          disabledDates = expandRangesToDates(data);
        }else if (Array.isArray(data.dates)){
          // ä¹Ÿæ”¯æ´ {dates: ["yyyy-mm-dd", ...]}
          disabledDates = data.dates;
        }
        fp.set("disable", disabledDates);
      }catch(err){
        console.warn("ç„¡æ³•è¼‰å…¥ä¸å¯é ç´„æ—¥æœŸï¼š", err);
      }
    }

    // ====== æ—¥æœŸé¸æ“‡å™¨ ======
    const fp = flatpickr("#daterange", {
      mode: "range",
      minDate: "today",
      dateFormat: "Y-m-d",
      disable: disabledDates,
      onReady(){ loadDisabledDates(); },
      onChange(dates) {
        if (dates.length === 2) {
          const [s,e] = dates;
          selectedDays = Math.round((e - s)/86400000) + 1;
          dateSummary.style.display = "block";
          dateSummary.innerHTML = `ğŸ“¦ é ˜å–æ—¥ï¼š<b>${toHuman(s)}</b><br>
ğŸ“¦ é‚„æ©Ÿæ—¥ï¼š<b>${toHuman(e)}</b><br>
â° ç§Ÿå€Ÿå¤©æ•¸ï¼š<b>${selectedDays} å¤©</b>`;
          updatePrice();
        } else {
          selectedDays = 0;
          dateSummary.style.display = "none";
          hidePrice();
        }
      }
    });

    // ====== åƒ¹æ ¼é¡¯ç¤ºï¼ˆåœ¨å¹£åˆ¥ä¸‹æ–¹ï¼‰======
    function hidePrice(){
      priceBox.style.display = "none";
      priceBox.textContent = "";
    }

    function getDailyPrice(device, days, currency){
      const table = currency === "KRW" ? PRICE_KRW : PRICE_TWD;
      const fn = table[device] || table._default;
      return fn(days);
    }

    function formatMoney(amount, currency){
      if(currency === "KRW") return "â‚©" + Number(amount).toLocaleString("ko-KR");
      return "NT$" + Number(amount).toLocaleString("zh-TW");
    }

    function updatePrice(){
      const device = $("#device").value;
      const currency = $("#currency").value;
      if (!device || !selectedDays || !currency) return hidePrice();

      const daily = getDailyPrice(device, selectedDays, currency);
      const total = daily * selectedDays;

      priceBox.style.display = "block";
      priceBox.innerHTML = `
        ğŸ’° <b>é ä¼°é‡‘é¡</b><br>
        â€£ æ©Ÿç¨®ï¼š${device}<br>
        â€£ å¤©æ•¸ï¼š${selectedDays} å¤© Ã— æ¯æ—¥ ${formatMoney(daily, currency)} = <b>${formatMoney(total, currency)}</b>
      `;
    }

    $("#device").addEventListener("change", updatePrice);
    $("#currency").addEventListener("change", updatePrice);

    // ====== è¡¨å–®é€å‡ºï¼ˆfetch JSONï¼›æœªå¡« ENDPOINT å‰‡åƒ…ç¤ºç¯„ï¼‰======
    $("#rentalForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const f = e.target;
      if (!f.reportValidity()) return;

      if (!selectedDays) return alert("è«‹å…ˆé¸æ“‡å®Œæ•´çš„ç§Ÿå€Ÿæ—¥æœŸå€é–“");
      if (!$("#device").value) return alert("è«‹é¸æ“‡ç§Ÿå€Ÿè¨­å‚™");
      if (!$("#currency").value) return alert("è«‹é¸æ“‡ä»˜æ¬¾å¹£åˆ¥");

      const btn = $("#submitBtn");
      const txt = btn.textContent;
      btn.disabled = true;
      btn.textContent = "é€å‡ºä¸­â€¦";

      try{
        const dates = fp.selectedDates;
        const device = $("#device").value;
        const currency = $("#currency").value;
        const daily = getDailyPrice(device, selectedDays, currency);
        const total = daily * selectedDays;

        const payload = {
          name: f.name.value.trim(),
          phone: f.phone.value.trim(),
          startDate: toYMD(dates[0]),
          endDate: toYMD(dates[1]),
          days: selectedDays,
          device,
          charger: $("#charger").checked ? "éœ€è¦" : "ä¸éœ€è¦",
          ig: f.ig.value.trim(),
          line: f.line.value.trim(),
          pickup: f.pickup.value,
          note: f.note.value.trim(),
          currency,
          dailyPrice: daily,
          totalPrice: total,
          agree: $("#agree").checked ? "yes" : "",
          timestamp: new Date().toISOString()
        };

        if (!ENDPOINT) {
          alert("ï¼ˆç¤ºç¯„ï¼‰å°šæœªä¸²æ¥å¾Œç«¯ï¼Œè¡¨å–®ä¸æœƒé€å‡ºã€‚ä¹‹å¾ŒæŠŠ ENDPOINT æ›æˆä½ çš„ API å³å¯ã€‚");
          console.log("payload", payload);
          btn.disabled = false; btn.textContent = txt;
          return;
        }

        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>null);

        if (res.ok && data && (data.status==="success" || data.ok===true)) {
          location.href = "thanks.html";
        } else {
          const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
          location.href = `error.html?msg=${encodeURIComponent(msg)}`;
        }
      } catch(err){
        location.href = `error.html?msg=${encodeURIComponent(err.message)}`;
      } finally{
        btn.disabled = false;
        btn.textContent = txt;
      }
    });
  </script>
</body>
</html>

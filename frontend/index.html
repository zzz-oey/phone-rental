<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>手機租借預約</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    :root{ --gap:16px; --gap-lg:24px; --border:#dcdcdc; --text:#111; --muted:#666; --bg:#f7f7f7; --btn:#000; --btn2:#222; }
    *{box-sizing:border-box}
    body{ font-family:"Helvetica Neue", Arial, "PingFang TC","Noto Sans TC", system-ui, sans-serif;
      color:var(--text); background:var(--bg); margin:0;
      padding:clamp(16px,4vw,32px); max-width:780px; margin-inline:auto; }
    h1{font-size:clamp(22px,4vw,28px); text-align:center; margin:0 0 var(--gap-lg)}
    .form-row{margin-bottom:var(--gap-lg)}
    .label{display:block; font-weight:700; margin-bottom:8px}
    .muted{color:var(--muted); font-size:14px}

    .control{
      width:100%; display:block; padding:12px; font-size:16px; line-height:1.2;
      border:1px solid var(--border); border-radius:8px; background:#fff; outline:none;
      min-height:48px;
    }
    select.control{
      height:48px; -webkit-appearance:none; appearance:none; padding-right:42px;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat:no-repeat; background-position:right 12px center; background-size:16px 16px;
    }
    .control:focus{border-color:#999; box-shadow:0 0 0 3px rgba(0,0,0,.06)}
    textarea.control{min-height:110px; resize:vertical}

    .checkbox{display:flex; align-items:flex-start; gap:10px}
    .checkbox input{width:20px; height:20px; margin-top:3px; accent-color:#111}
    .row-flex{display:flex; gap:8px; align-items:center}

    .summary{
      display:none; background:#eef3ff; border:1px solid #dbe3ff; color:#173b8e;
      border-radius:8px; padding:12px; margin-top:-6px; margin-bottom:var(--gap-lg); line-height:1.6; font-size:16px;
    }
    .summary b{font-weight:700}
    .req{ color:#d93025; font-weight:700; }
    .red{ color:#d93025; font-weight:700; }

    a.link{ color:#1a73e8; text-decoration:underline; }
    a.link:hover{ color:#0b5ed7; }
    a.link:visited, a.link.clicked{ color:#551A8B; }

    .actions{margin-top:28px}
    button{
      width:100%; padding:14px 18px; font-size:16px; border:none; border-radius:10px;
      color:#fff; background:var(--btn); cursor:pointer;
    }
    button:hover{background:var(--btn2)}
    button[disabled]{opacity:.6; cursor:not-allowed}

    /* Guide Modal */
    .modal{ display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.5); align-items:center; justify-content:center; }
    .modal-content{ background:#fff; width:min(760px,92vw); max-height:82vh; display:flex; flex-direction:column; border-radius:12px; padding:20px; }
    .guide-body{ line-height:1.7; font-size:15px; overflow:auto; max-height:calc(82vh - 64px); }
    .guide-body h3{ margin:14px 0 8px; font-size:16px }
    .guide-body ul{ padding-left:20px }
    .guide-footer{ margin-top:12px; }
    .close-bottom{ margin-top:12px; width:100%; }

    .note { margin-top:6px; font-size:14px; color:#444; }
  </style>
</head>
<body>
  <h1>手機租借預約</h1>

  <form id="rental-form" novalidate autocomplete="off">
    <div class="form-row">
      <label class="label" for="name">姓名（必填）</label>
      <input class="control" type="text" id="name" name="name" required autocomplete="off"/>
    </div>

    <div class="form-row">
      <label class="label" for="phone">聯絡電話（必填）</label>
      <!-- 僅允許 11 位數字；超過自動截斷 -->
      <input
        class="control"
        type="tel"
        id="phone"
        name="phone"
        inputmode="numeric"
        pattern="\\d{11}"
        maxlength="11"
        placeholder="請輸入有效電話號碼"
        required
        autocomplete="off"
      />
    </div>

    <!-- 電子信箱（必填） + 動態網域下拉 -->
    <div class="form-row">
      <label class="label" for="email">電子信箱（必填）</label>
      <input
        class="control"
        type="email"
        id="email"
        name="email"
        placeholder="yourname@example.com"
        list="emailHints"
        required
        autocomplete="off"
      />
      <datalist id="emailHints"></datalist>
      <div class="muted" style="margin-top:6px">輸入「@」後會出現常見網域建議（可繼續輸入篩選）。</div>
    </div>

    <div class="form-row">
      <label class="label" for="contactType">聯絡方式（必填）</label>
      <div class="row-flex">
        <select id="contactType" name="contactType" class="control" style="flex:0.35" required>
          <option value="" disabled selected>選擇方式</option>
          <option value="IG">IG</option>
          <option value="LINE">LINE</option>
        </select>
        <input type="text" id="contactId" name="contactId" class="control" style="flex:0.65"
               placeholder="請輸入帳號" required autocomplete="new-password"/>
      </div>
    </div>

    <!-- 活動名稱（必填，但不影響試算） -->
    <div class="form-row">
      <label class="label" for="event">活動名稱（必填）</label>
      <input class="control" type="text" id="event" name="event" placeholder="請填入演唱會或藝人名稱，例：BTS演唱會" required autocomplete="off"/>
    </div>

    <!-- 日期區間 -->
    <div class="form-row">
      <label class="label" for="daterange">租借日期區間（必填）</label>
      <input class="control" type="text" id="daterange" name="daterange" required placeholder="請選擇日期區間（最少租借日為24小時/1天）" autocomplete="off"/>
      <div class="muted" style="margin-top:6px">計費以 24 小時為 1 天，自下方<strong>取機時間</strong>起算。</div>
    </div>

    <!-- 取機地點 -->
    <div class="form-row">
      <label class="label" for="pickup">預計取機地點（必填）</label>
      <select class="control" id="pickup" name="pickup" required>
        <option value="" disabled selected>請選擇</option>
        <option>弘大（홍대）</option>
        <option>合井（합정）</option>
        <option>上水（상수）</option>
        <option>九老數碼園區（구로디지털단지）</option>
        <option>其他（請在備註填寫）</option>
      </select>
    </div>

    <!-- 取機時間（依地點提供固定時段） -->
    <div class="form-row">
      <label class="label" for="pickupTime">取機時間 <span class="red">（起算時間，必填）</span></label>
      <select class="control" id="pickupTime" name="pickupTime" required disabled>
        <option value="" selected>請先選擇取機地點</option>
      </select>
      <div id="pickupTimeNote" class="note"></div>
    </div>

    <!-- 還機時間（同樣用下拉選單） -->
    <div class="form-row">
      <label class="label" for="returnTime">預計還機時間 <span class="red">（可不同於起算時間）</span></label>
      <select class="control" id="returnTime" name="returnTime" required disabled>
        <option value="" selected>請先選擇取機地點</option>
      </select>
      <div class="muted" style="margin-top:6px">若晚於起算時間，系統將依規則自動估算逾時費：2小時內按小時，2小時以上為半天，<b>超過8小時為一天</b>。</div>
    </div>

    <!-- 摘要 -->
    <div id="summary" class="summary" aria-live="polite">
      📦 領取：<b id="pickup-date"></b><br />
      📦 歸還：<b id="return-date"></b><br />
      ⏰ 租借天數（24h為一日）：<b id="rental-days"></b>
    </div>

    <div class="form-row">
      <label class="label" for="model">租借設備（必填）</label>
      <select class="control" id="model" name="model" required>
        <option value="" disabled selected>請選擇</option>
        <option value="S23 Ultra 黑 256G">Samsung Galaxy S23 Ultra 黑 256G（已貼保護貼）</option>
      </select>
    </div>

    <div class="form-row">
      <label class="label">加值配件</label>
      <label class="checkbox" for="charger">
        <input type="checkbox" id="charger" name="charger" />
        <span>需要 Type-C 充電頭（免費借用，請先勾選確保準備）</span>
      </label>
      <label class="checkbox" for="usba">
        <input type="checkbox" id="usba" name="usba" />
        <span>需要 Type-C ⇄ Type-C 線（可替換為 USB ⇄ Type-C，如有需要更換請在備註欄填寫。）</span>
      </label>
    </div>

    <!-- 付款幣別 -->
    <div class="form-row">
      <label class="label" for="currency">付款幣別（必填）</label>
      <select class="control" id="currency" name="currency" required>
        <option value="" disabled selected>請選擇幣別</option>
        <option value="TWD">台幣</option>
        <option value="KRW">韓幣</option>
      </select>
    </div>

    <!-- 金額摘要 -->
    <div id="priceSummary" class="summary" aria-live="polite" style="display:none"></div>

    <div class="form-row">
      <label class="label" for="note">備註</label>
      <textarea class="control" id="note" name="note" placeholder="若需不同歸還日期/時間、特殊需求（Water Bomb/長時拍攝）、或其他地點，請在此補充。" autocomplete="off"></textarea>
    </div>

    <div class="form-row">
      <label class="checkbox" for="agree">
        <input type="checkbox" id="agree" name="agree" required disabled />
        <span>我已閱讀並同意 <a href="#guide" id="guideLink" class="link">租借指南</a>（必填）</span>
      </label>
      <div class="muted">送出代表同意租借、押金、逾時與賠償相關規範。</div>
    </div>

    <div class="actions">
      <button id="submitBtn" type="submit">送出預約</button>
    </div>
  </form>

  <!-- 租借指南彈窗 -->
  <div id="guideModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="modal-content">
      <h2 id="guideTitle">S23U手機租借指南</h2>
      <div id="guideScroll" class="guide-body">
        <h3>【租借設備】</h3>
        <ul>
          <li>Samsung Galaxy S23 Ultra 黑 256G（已貼保護貼）</li>
          <li>附手機殼、Type-C 對 Type-C 充電線（可事先告知是否需要充電頭或是否需要換成 USB 對 Type-C 充電線）</li>
        </ul>

        <h3>【租借費用】（台幣）</h3>
        <ul>
          <li>1–2天：NT$700/日</li>
          <li>3–4天：NT$650/日</li>
          <li>5天(含)以上：NT$600/日</li>
          <li>訂金：NT$500</li>
        </ul>
        <p>👉 <b>以 24 小時為 1 天</b> 計算，自面交當天時間起算。</p>
        <p>例1：8/1 20:00 取機 → 8/2 20:00 歸還 = 1 天<br>
           例2：8/1 20:00 取機 → 8/5 20:00 歸還 = 4 天</p>
        <p>⏰ 超時：每小時 NT$100，上限 NT$700/日。</p>
        <ul>
          <li>超時 2 小時以內 → 每小時 NT$100（或 KR₩4,000）。</li>
          <li>超時 2 小時以上 → 以「半天」NT$350（或 KR₩16,000）計算。</li>
          <li><b>超過 8 小時 → 以 1 天計算。</b></li>
        </ul>

        <h3>【租借費用】（韓幣）</h3>
        <ul>
          <li>1–2天：KR₩ 32,000/日</li>
          <li>3–4天：KR₩ 30,000/日</li>
          <li>5天(含)以上：KR₩ 28,000/日</li>
          <li>訂金：KR₩ 20,000</li>
        </ul>
        <p>👉👉 <b>以 24 小時為 1 天</b> 計算，自面交當天時間起算。</p>
        <p>例1：8/1 20:00 取機 → 8/2 20:00 歸還 = 1 天<br>
           例2：8/1 20:00 取機 → 8/5 20:00 歸還 = 4 天</p>
        <p>⏰ 超時：每小時 KR₩ 4,000，上限 KR₩ 32,000/日。</p>
        <ul>
          <li>超時 2 小時以內 → 每小時 KR₩4,000。</li>
          <li>超時 2 小時以上 → 以「半天」 KR₩16,000 計算。</li>
          <li><b>超過 8 小時 → 以 1 天計算。</b></li>
        </ul>

        <h3>【面交地點與時段】</h3>
        <ul>
          <li>弘大（홍대）→ 可領取／歸還時間：晚上 8:00 – 晚上 11:30</li>
          <li>合井（합정）→ 可領取／歸還時間：晚上 8:00 – 晚上 11:30</li>
          <li>上水（상수）→ 可領取／歸還時間：晚上 8:00 – 晚上 11:30</li>
          <li>九老數碼園區（구로디지털단지）→ 可領取／歸還時間：早上 11:00 – 晚上 7:00</li>
          <li>其他地點 → 須先與出租方協調（系統將以 20:00 暫定試算）。</li>
        </ul>
        
        <h3>【押金及證件】</h3>
        <ul>
          <li>押金 NT$3000（或 KRW 120,000）</li>
          <li>本人有效證件正本（身分證、健保卡、駕照 擇一）</li>
        </ul>
        <ul>
          <li>⚠️ 無證件抵押者，需繳更高額押金 NT$25,000（或 KRW 1,000,000）。</li>
          <li>⚠️ 押金與證件會在歸還、檢查完畢後一併退還。</li>
        </ul>

        <h3>【預約流程】</h3>
        <ol>
          <li>確認欲租借日期（可提前 1–2 個月預約）</li>
          <li>填寫基本資訊：姓名／電話／聯絡方式（IG/ LINE）／欲租借日期／活動名稱／面交地點</li>
          <li>支付訂金 NT$500（保留手機，取消不退還）</li>
          <li>面交時支付尾款＋押金＋本人有效證件正本</li>
          <li>租借結束，檢查手機狀態 → 歸還押金與證件</li>
        </ol>

        <h3>【租借注意事項】</h3>
        <ol>
          <li><b>承租資格</b>：承租人需年滿 18 歲，並以本人名義租借與使用，不得轉借、分租或供第三人使用。</li>
          <li><b>資料清除與備份</b>：承租人須自行負責租借期間於設備上所產生或儲存的個人資料，並於歸還前完成備份與刪除；若因未清除或備份不足而導致資料外洩或遺失，出租方不承擔任何責任。</li>
          <li><b>個資安全提醒</b>：承租時僅需提供本人有效證件正本，僅作為租借期間的抵押保障用，出租方不會另行複製或留存；手機歸還檢查完成後，會與押金一併返還。承租人應自行注意帳號安全，並於歸還前刪除個人資料。</li>
          <li><b>設備檢查</b>：面交時雙方需確認手機外觀、功能，並可錄影或拍照存證。</li>
          <li><b>使用限制</b>：不得隨意下載非必要或危險 App；若造成中毒或故障，承租人需負維修費。</li>
          <li><b>賠償規範</b>：手機若遺失、損壞、刮傷或進水，需依 Samsung 原廠維修／換新報價賠償（含配件）。出租方可先行扣抵押金，若不足需由承租人補足。</li>
          <li><b>電量檢查配合</b>：歸還時請盡量保留電量（20–30%），方便立即完成檢查；若電量不足導致無法當場檢測，可能需延後退還押金。</li>
          <li><b>超時處理</b>：超時 2 小時以內，每小時收費 NT$100（KR₩4,000）；超過 2 小時以半天計算 NT$350（KR₩16,000）；<b>超過 8 小時以 1 天計算</b>。若因此影響後續租借安排，除訂金不予退還外，承租人並需額外賠償出租人因超時造成的租金損失。</li>
          <li><b>租期規範</b>：租借以 24 小時為 1 日計算，訂金恕不退還。租借開始日一週內，若有<b>大幅更動（例如更改 2 天以上或整段時程）</b>，出租方得視情況自訂金中扣除 NT$200（KR₩8,000）作為協調與排程辛苦費，且不保證欲更改的日期區間一定能租借，將以首次預約時段為優先。</li>
          <li><b>故障處理</b>：租借期間如發生異常或故障，承租人應立即通知出租方；若確認為人為因素，則需依照注意事項第 6 點賠償。</li>
          <li><b>規則修正</b>：出租方保留調整租借規則與價格之權利，若有變更將提前公告並通知承租人。</li>
          <li><b>使用提醒</b>：請妥善保管設備，避免不當操作或高風險環境使用，包括長時間曝曬、高溫環境或涉水情況。若有特殊需求（如 Water Bomb、戶外長時間拍攝等），請務必事先告知出租方，以利協調並保障雙方權益。</li>
        </ol>
      </div>
      <button class="close-bottom" id="closeGuideBtn" type="button">關閉</button>
      <div class="guide-footer muted">（已閱讀至底部後，將自動解鎖「同意」勾選）</div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbw96IKgRxbRIXhsHbaYArxV2jKJYTEcJh2EDp23To3x9mh38yXU_zocA7rCP-X-cH8O/exec";
    const $ = (id)=>document.getElementById(id);
    const summary = $("summary"), pickupEl=$("pickup-date"), returnEl=$("return-date"), daysEl=$("rental-days"), priceSummary=$("priceSummary");

    function depositOf(c){ return c==='KRW'?120000:3000; }
    function sign(c){ return c==='KRW'?'₩':'$'; }
    function fmt(c,n){ return sign(c)+Number(n).toLocaleString(); }
    function unitPrice(c,d){ if(c==='TWD'){ if(d>=5)return 600; if(d<=2)return 700; return 650; } if(c==='KRW'){ if(d>=5)return 28000; if(d<=2)return 32000; return 30000;} return 0;}
    const Overage={TWD:{perHour:100,halfDay:350,perDay:700},KRW:{perHour:4000,halfDay:16000,perDay:32000}};

    (function(){ document.querySelectorAll('label,.label,h1,h2,h3,h4').forEach(el=>{ el.innerHTML=el.innerHTML.replace(/（必填）/g,'<span class="req">（必填）</span>'); }); })();

    function toYMDLocal(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
    function wd(d){return ['日','一','二','三','四','五','六'][d.getDay()]}
    function daysBy24h(s,e,t){const[hh,mm]=t.split(':').map(Number);const S=new Date(s.getFullYear(),s.getMonth(),s.getDate(),hh,mm||0,0);const E=new Date(e.getFullYear(),e.getMonth(),e.getDate(),hh,mm||0,0);const ms=E-S;if(ms<=0)return{days:0,startDT:S,endDT:E};return{days:Math.ceil(ms/86400000),startDT:S,endDT:E};}
    function calcOverage(c,plannedEndDT,rtStr){ if(!rtStr) return{hours:0,fee:0,rule:'none'}; const[rh,rm]=rtStr.split(':').map(Number); const actual=new Date(plannedEndDT.getFullYear(),plannedEndDT.getMonth(),plannedEndDT.getDate(),rh,rm||0,0); const diff=actual-plannedEndDT; if(diff<=0) return{hours:0,fee:0,rule:'none'}; const h=Math.ceil(diff/3600000); const cfg=Overage[c]||Overage.TWD; if(h<=2) return{hours:h,fee:Math.min(h*cfg.perHour,cfg.perDay),rule:'hourly'}; if(h<=8) return{hours:h,fee:cfg.halfDay,rule:'half'}; return{hours:h,fee:cfg.perDay,rule:'day'}; }

    // 可取/還機時段
    const TIME_WINDOWS = {
      "弘大（홍대）": { start: "20:00", end: "23:30" },
      "合井（합정）": { start: "20:00", end: "23:30" },
      "上水（상수）": { start: "20:00", end: "23:30" },
      "九老數碼園區（구로디지털단지）": { start: "11:00", end: "19:00" }
    };
    const OTHER_PLACE_SLOT = "20:00"; // 其他地點暫定估算用

    function genSlots(start,end,stepMin=30){
      const [sh,sm]=start.split(':').map(Number), [eh,em]=end.split(':').map(Number);
      let cur = new Date(2000,0,1,sh,sm,0), last = new Date(2000,0,1,eh,em,0);
      const out=[];
      while(cur<=last){ const hh=String(cur.getHours()).padStart(2,'0'); const mm=String(cur.getMinutes()).padStart(2,'0'); out.push(`${hh}:${mm}`); cur.setMinutes(cur.getMinutes()+stepMin); }
      return out;
    }

    let disabledSet = new Set();
    let returnManuallyChanged = false;

    async function init(){
      // 已預約日
      let disabledRanges=[];
      try{
        const r=await fetch(API_BASE+"?action=reserved",{cache:"no-store"}); const ranges=await r.json();
        if(Array.isArray(ranges)){
          disabledRanges=ranges.map(x=>({from:x.start,to:x.end}));
          ranges.forEach(({start,end})=>{
            const s=new Date(start), e=new Date(end);
            const cur=new Date(s.getFullYear(),s.getMonth(),s.getDate());
            const last=new Date(e.getFullYear(),e.getMonth(),e.getDate());
            while(cur<=last){ disabledSet.add(toYMDLocal(cur)); cur.setDate(cur.getDate()+1); }
          });
        }
      }catch(err){ console.warn("取得預約區間失敗：",err); }

      // 日期（最短24h）
      flatpickr("#daterange",{
        mode:"range", minDate:"today", allowInput:false, dateFormat:"Y-m-d to Y-m-d", disable:disabledRanges,
        onChange:(dates,_s,inst)=>{
          if(dates.length===1){ inst.input.value=""; hideSummaries(); return; }
          if(dates.length===2){
            const d0=new Date(dates[0].getFullYear(),dates[0].getMonth(),dates[0].getDate());
            const d1=new Date(dates[1].getFullYear(),dates[1].getMonth(),dates[1].getDate());
            if(d0.getTime()===d1.getTime()){ const next=new Date(d0); next.setDate(d0.getDate()+1); inst.setDate([d0,next],true); }
            else{ inst.input.value=`${inst.formatDate(dates[0],"Y-m-d")} to ${inst.formatDate(dates[1],"Y-m-d")}`; updateSummaries(); updatePrice(); }
          }
        }
      });

      // 電話輸入：僅數字 + 最長 11 位
      $("phone").addEventListener("input", (e)=>{
        const v = e.target.value.replace(/\D+/g,"").slice(0,11);
        e.target.value = v;
      });

      // 電子信箱提示
      const commonDomains = ["gmail.com","yahoo.com","yahoo.com.tw","icloud.com","hotmail.com","outlook.com","hotmail.com.tw"];
      const emailInput = $("email");
      const emailHints = $("emailHints");
      emailInput.addEventListener("input", ()=>{
        const val = emailInput.value;
        emailHints.innerHTML = "";
        const atIdx = val.indexOf("@");
        if(atIdx === -1){
          // 尚未輸入 @ ：給常見網域預覽
          commonDomains.forEach(dm=>{
            const opt = document.createElement("option");
            opt.value = `${val}@${dm}`.replace(/^@/,"user@"); // 避免使用者一開始就輸入@的邊界
            emailHints.appendChild(opt);
          });
        }else{
          const local = val.slice(0, atIdx);
          const typedDom = val.slice(atIdx+1).toLowerCase();
          commonDomains
            .filter(dm=> dm.startsWith(typedDom))
            .forEach(dm=>{
              const opt = document.createElement("option");
              opt.value = `${local}@${dm}`;
              emailHints.appendChild(opt);
            });
        }
      });

      // 地點→時段
      $("pickup").addEventListener("change", onPickupPlaceChange);

      $("pickupTime").addEventListener("change", ()=>{
        if(!returnManuallyChanged){ $("returnTime").value = $("pickupTime").value || OTHER_PLACE_SLOT; }
        updateSummaries(); updatePrice();
      });

      $("returnTime").addEventListener("change", ()=>{ returnManuallyChanged = true; updateSummaries(); updatePrice(); });

      ["model","currency","charger","usba","contactType","contactId","pickup","note","event"].forEach(id=>{
        const el=$(id); if(el) el.addEventListener('change', ()=>{ updatePrice(); });
      });

      document.getElementById("rental-form").addEventListener("submit", onSubmit);

      // 指南彈窗
      const link=$("guideLink");
      link.addEventListener("click",(e)=>{ e.preventDefault(); link.classList.add("clicked"); openGuide(); });
      $("closeGuideBtn").addEventListener("click", ()=> closeGuide());
      $("guideModal").addEventListener("click", (e)=>{ if(e.target.id==="guideModal") closeGuide(); });
      $("guideScroll").addEventListener("scroll", onGuideScroll);

      updateSummaries(); updatePrice();
    }

    function fillSelectOptions(select, slots, placeholder){
      select.innerHTML = "";
      select.disabled = false;
      if(!slots || !slots.length){
        const opt=document.createElement("option");
        opt.value=""; opt.textContent=placeholder||"無可選時段";
        select.appendChild(opt);
        select.disabled = true;
        return;
      }
      slots.forEach(t=>{
        const opt=document.createElement("option");
        opt.value=t; opt.textContent=t;
        select.appendChild(opt);
      });
    }

    function onPickupPlaceChange(){
      const place = $("pickup").value;
      const pSel = $("pickupTime");
      const rSel = $("returnTime");
      const note = $("pickupTimeNote");
      pSel.innerHTML = ""; rSel.innerHTML = ""; pSel.disabled = rSel.disabled = false;

      const win = TIME_WINDOWS[place];
      if(!place){
        pSel.disabled = rSel.disabled = true;
        pSel.innerHTML = `<option value="" selected>請先選擇取機地點</option>`;
        rSel.innerHTML = `<option value="" selected>請先選擇取機地點</option>`;
        note.textContent = "";
        return;
      }

      if(!win){ // 其他地點：以 20:00 暫定
        const opt1=document.createElement("option");
        opt1.value=OTHER_PLACE_SLOT; opt1.textContent=`協調時間（暫以 ${OTHER_PLACE_SLOT} 試算）`;
        pSel.appendChild(opt1); pSel.value=OTHER_PLACE_SLOT;

        const opt2=document.createElement("option");
        opt2.value=OTHER_PLACE_SLOT; opt2.textContent=`協調時間（暫以 ${OTHER_PLACE_SLOT} 試算）`;
        rSel.appendChild(opt2); rSel.value=OTHER_PLACE_SLOT;

        note.textContent = `其餘地點須協調，系統暫以 ${OTHER_PLACE_SLOT} 進行金額試算，實際時間另行確認。`;
        returnManuallyChanged = false;
        updateSummaries(); updatePrice();
        return;
      }

      const slots = genSlots(win.start, win.end, 30);
      fillSelectOptions(pSel, slots, "無時段");
      fillSelectOptions(rSel, slots, "無時段");
      pSel.value = slots[0];
      if(!returnManuallyChanged){ rSel.value = pSel.value; }
      note.textContent = `可領取時間：${win.start}–${win.end}`;
      returnManuallyChanged = false;
      updateSummaries(); updatePrice();
    }

    function hideSummaries(){ $("summary").style.display="none"; priceSummary.style.display="none"; priceSummary.innerHTML=""; }
    function getSelectedDates(){ const fp=$("daterange")._flatpickr; const sel=fp?.selectedDates||[]; return sel.length===2?sel:null; }

    function updateSummaries(){
      const sel=getSelectedDates(); const t=$("pickupTime").value;
      if(!sel || !t){ hideSummaries(); return; }
      const [s,e]=sel; const r=daysBy24h(s,e,t); const d=r.days;
      $("summary").style.display="block";
      pickupEl.textContent = `${s.getFullYear()}/${s.getMonth()+1}/${s.getDate()} ${t}（${wd(s)}）`;
      const rt = $("returnTime").value || t;
      returnEl.textContent = `${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()} ${rt}（${wd(e)}）`;
      daysEl.textContent = d>0 ? `${d}天` : "—";
    }

    function updatePrice(){
      const model=$("model").value;
      const currency=$("currency").value;
      const sel=getSelectedDates();
      const t=$("pickupTime").value;
      const rtSel = $("returnTime").value;
      const place=$("pickup").value||"";

      if(!currency){ priceSummary.style.display='none'; priceSummary.innerHTML=''; return; }

      // 只檢查會影響試算的欄位
      const missing=[];
      if(!sel) missing.push('租借日期區間');
      if(!place) missing.push('取機地點');
      if(!t && place && !place.includes('其他')) missing.push('取機時間');
      if(!rtSel && place && !place.includes('其他')) missing.push('還機時間');
      if(!model) missing.push('租借設備');

      if(missing.length){
        priceSummary.innerHTML = `
          🔔 <b>請先完成以下項目以顯示試算：</b><br>
          • ${missing.join('、')}<br>
          <hr style="border:none;border-top:1px solid #dbe3ff; margin:10px 0;">
          <span class="muted">※ 逾時規則：2 小時內按小時、2–8 小時半天、超過 8 小時一天。</span>
        `;
        priceSummary.style.display='block';
        return;
      }

      const [s,e]=sel;
      const {days,endDT}=daysBy24h(s,e,t || OTHER_PLACE_SLOT);
      if(days<=0){ priceSummary.style.display='none'; return; }

      const per=unitPrice(currency,days);
      const rentTotal=per*days;
      const deposit=depositOf(currency);
      const grand=rentTotal+deposit;

      const rtStr= rtSel || (t || OTHER_PLACE_SLOT);
      const over=calcOverage(currency,endDT,rtStr);

      const ruleMap={ none:'無逾時', hourly:`2 小時內，按小時計（${currency==='KRW'?'₩4,000':'$100'}/小時）`, half:'超過 2 小時，以半天計', day:'超過 8 小時，以 1 天計' };
      const trialHint = place.includes('其他') ? `　<span class="muted">（其他地點暫以 <b>${OTHER_PLACE_SLOT}</b> 試算）</span>` : '';

      priceSummary.innerHTML = `
        💰 租金總額：<b>${fmt(currency, rentTotal)}</b><br>
        🔒 押金：<b>${fmt(currency, deposit)}</b><br>
        📊 總額（租金+押金）：<b>${fmt(currency, grand)}</b><br>
        （${days}天 × 每日 <b>${fmt(currency, per)}</b>，以 <b>${t || OTHER_PLACE_SLOT}</b> 起算 24h/日）${trialHint}<br>
        <hr style="border:none;border-top:1px solid #dbe3ff; margin:10px 0;">
        ⏰ 預估逾時費：<b>${fmt(currency, over.fee)}</b>　<span class="muted">（${ruleMap[over.rule]}；晚 <b>${over.hours}</b> 小時）</span><br>
        <span class="muted">※ 逾時費僅供預估，實際於歸還當日依規定結算，不併入預付總額。</span><br>
        <span class="muted">※ 逾時規則：2 小時內按小時、2–8 小時半天、超過 8 小時一天。</span>
      `;
      priceSummary.style.display='block';
    }

    async function onSubmit(e){
      e.preventDefault();
      const f=e.target;

      if(!f.name.value.trim()){ alert("請輸入姓名"); return; }
      if(!/^\d{11}$/.test(f.phone.value.trim())){ alert("請輸入 11 位數字的聯絡電話"); return; }
      if(!f.email.checkValidity()){ alert("請輸入有效的電子信箱"); return; }
      if(!$("event").value.trim()){ alert("請輸入活動名稱"); return; }

      const sel=getSelectedDates(); if(!sel){ alert("請選擇完整的租借日期區間！"); return; }

      const place=$("pickup").value;
      if(!place){ alert("請選擇取機地點"); return; }

      const pickupTime = $("pickupTime").value || OTHER_PLACE_SLOT;
      const returnTimeStr = $("returnTime").value || pickupTime;

      if(!$("model").value){ alert("請選擇租借設備！"); return; }
      if(!$("currency").value){ alert("請選擇付款幣別！"); return; }
      if(!$("contactType").value){ alert("請選擇聯絡方式（IG/LINE）"); return; }
      if(!$("contactId").value.trim()){ alert("請輸入聯絡帳號"); return; }
      if(!$("agree").checked){ alert("請先開啟並閱讀租借指南至底部，才能勾選同意！"); return; }

      const [s,eDate]=sel;

      // 檢查已預約日
      let cur=new Date(s.getFullYear(),s.getMonth(),s.getDate());
      const last=new Date(eDate.getFullYear(),eDate.getMonth(),eDate.getDate());
      while(cur<=last){ if(disabledSet.has(toYMDLocal(cur))){ alert(`❌ 重複日期：${toYMDLocal(cur)} 已被預約，請改選其他日期。`); return;} cur.setDate(cur.getDate()+1); }

      const {days,startDT,endDT}=daysBy24h(s,eDate,pickupTime);
      const currency=$("currency").value;
      const per=unitPrice(currency,days);
      const rentTotal=per*days;
      const deposit=depositOf(currency);
      const grand=rentTotal+deposit;
      const over=calcOverage(currency,endDT,returnTimeStr);

      const payload={
        name:f.name.value.trim(),
        phone:f.phone.value.trim(),
        email:f.email.value.trim(),
        startDate:toYMDLocal(s),
        endDate:toYMDLocal(eDate),
        pickupTime,
        returnTime:returnTimeStr,
        startISO:startDT.toISOString(),
        plannedEndISO:endDT.toISOString(),
        estimatedOverageHours:over.hours,
        estimatedOverageFee:over.fee,
        estimatedOverageRule:over.rule,
        days:`${days}天（24h/日制）`,
        model:f.model.value,
        charger:f.charger?.checked?"需要":"不需要",
        usba:f.usba?.checked?"需要":"不需要",
        contactType:$("contactType").value,
        contactId:$("contactId").value.trim(),
        event:$("event").value.trim(),
        pickup:place,
        pickupTimeIsProvisional: place.includes('其他') ? 'yes' : 'no',
        note:$("note").value.trim(),
        currency,
        dailyPrice:per,
        rentTotal,
        deposit,
        grandTotal:grand,
        agree:"yes",
        timestamp:new Date().toISOString(),
      };

      const btn=$("submitBtn"); const txt=btn.textContent;
      btn.disabled=true; btn.textContent="送出中…";
      try{
        const res=await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const text=await res.text(); let result; try{ result=JSON.parse(text);}catch{ alert("❌ 後端不是 JSON 回應：\n\n"+text.slice(0,500)); return;}
        if(result && (result.success===true || result.status==="success")){ window.location.href="thanks.html"; }
        else{ alert("❌ 預約失敗："+((result && (result.message||result.error))||"未知錯誤")); }
      }catch(err){ alert("❌ 送出失敗："+err.message); }
      finally{ btn.disabled=false; btn.textContent=txt; }
    }

    // 指南彈窗
    function openGuide(){ $("guideModal").style.display="flex"; const sc=$("guideScroll"); sc.scrollTop=0; $("agree").checked=false; $("agree").disabled=true; }
    function closeGuide(){ $("guideModal").style.display="none"; }
    function onGuideScroll(){ const sc=$("guideScroll"); if(sc.scrollTop+sc.clientHeight >= sc.scrollHeight-8){ $("agree").disabled=false; } }

    init();
  </script>
</body>
</html>

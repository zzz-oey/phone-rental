<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ‰‹æ©Ÿç§Ÿå€Ÿé ç´„</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    :root{ --gap:16px; --gap-lg:24px; --border:#dcdcdc; --text:#111; --muted:#666; --bg:#f7f7f7; --btn:#000; --btn2:#222; }
    *{box-sizing:border-box}
    body{ font-family:"Helvetica Neue", Arial, "PingFang TC","Noto Sans TC", system-ui, sans-serif;
      color:var(--text); background:var(--bg); margin:0;
      padding:clamp(16px,4vw,32px); max-width:780px; margin-inline:auto; }
    h1{font-size:clamp(22px,4vw,28px); text-align:center; margin:0 0 var(--gap-lg)}
    .form-row{margin-bottom:var(--gap-lg)}
    .label{display:block; font-weight:700; margin-bottom:8px}
    .muted{color:var(--muted); font-size:14px}

    .control{
      width:100%; display:block; padding:12px; font-size:16px; line-height:1.2;
      border:1px solid var(--border); border-radius:8px; background:#fff; outline:none;
      min-height:48px;
    }
    select.control{
      height:48px; -webkit-appearance:none; appearance:none; padding-right:42px;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat:no-repeat; background-position:right 12px center; background-size:16px 16px;
    }
    .control:focus{border-color:#999; box-shadow:0 0 0 3px rgba(0,0,0,.06)}
    textarea.control{min-height:110px; resize:vertical}

    .checkbox{display:flex; align-items:flex-start; gap:10px}
    .checkbox input{width:20px; height:20px; margin-top:3px; accent-color:#111}
    .row-flex{display:flex; gap:8px; align-items:center}

    .summary{
      display:none; background:#eef3ff; border:1px solid #dbe3ff; color:#173b8e;
      border-radius:8px; padding:12px; margin-top:-6px; margin-bottom:var(--gap-lg); line-height:1.6; font-size:16px;
    }
    .summary b{font-weight:700}
    .req{ color:#d93025; font-weight:700; }

    .actions{margin-top:28px}
    button{
      width:100%; padding:14px 18px; font-size:16px; border:none; border-radius:10px;
      color:#fff; background:var(--btn); cursor:pointer;
    }
    button:hover{background:var(--btn2)}
    button[disabled]{opacity:.6; cursor:not-allowed}

    details.guide{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px 16px; margin-top:28px;
    }
    details.guide summary{cursor:pointer; font-weight:800; font-size:18px; outline:none}
    .guide h3{margin:16px 0 8px; font-size:16px}
    .pill{ display:inline-block; padding:4px 8px; border:1px solid #e5e5e5; border-radius:999px; font-size:12px; color:#555; margin-right:6px; margin-top:6px; }
    .hr{height:1px; background:#eee; margin:14px 0}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; background:#f3f3f3; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <h1>æ‰‹æ©Ÿç§Ÿå€Ÿé ç´„</h1>

  <form id="rental-form" novalidate autocomplete="off">
    <div class="form-row">
      <label class="label" for="name">å§“åï¼ˆå¿…å¡«ï¼‰</label>
      <input class="control" type="text" id="name" name="name" required autocomplete="off"/>
    </div>

    <div class="form-row">
      <label class="label" for="phone">è¯çµ¡é›»è©±ï¼ˆå¿…å¡«ï¼‰</label>
      <input class="control" type="tel" id="phone" name="phone" required
             pattern="^[0-9+()\\-\\s]{6,}$" placeholder="è«‹è¼¸å…¥æœ‰æ•ˆé›»è©±" autocomplete="off"/>
    </div>

    <!-- æ—¥æœŸå€é–“ + èµ·ç®—æ™‚é–“ + é‚„æ©Ÿæ™‚é–“ -->
    <div class="form-row">
      <label class="label" for="daterange">ç§Ÿå€Ÿæ—¥æœŸå€é–“ï¼ˆå¿…å¡«ï¼‰</label>
      <input class="control" type="text" id="daterange" name="daterange" required placeholder="è«‹é¸æ“‡æ—¥æœŸå€é–“ï¼ˆå–®æ—¥è«‹å°‡åŒä¸€æ—¥æœŸé»å…©æ¬¡ï¼‰" autocomplete="off"/>
      <div class="muted" style="margin-top:6px">è¨ˆè²»ä»¥ 24 å°æ™‚ç‚º 1 å¤©ï¼Œè‡ªä¸‹æ–¹<strong>å–æ©Ÿæ™‚é–“</strong>èµ·ç®—ã€‚</div>
    </div>

    <div class="form-row">
      <label class="label" for="pickupTime">å–æ©Ÿæ™‚é–“ï¼ˆèµ·ç®—æ™‚é–“ï¼Œå¿…å¡«ï¼‰</label>
      <input class="control" type="text" id="pickupTime" name="pickupTime" required placeholder="ä¾‹ï¼š20:00ï¼ˆ24å°æ™‚åˆ¶ï¼‰" autocomplete="off"/>
    </div>

    <div class="form-row">
      <label class="label" for="returnTime">é è¨ˆé‚„æ©Ÿæ™‚é–“ï¼ˆå¯ä¸åŒæ–¼èµ·ç®—æ™‚é–“ï¼‰</label>
      <input class="control" type="text" id="returnTime" name="returnTime" placeholder="é è¨­èˆ‡å–æ©Ÿæ™‚é–“ç›¸åŒï¼Œå¯èª¿æ•´" autocomplete="off"/>
      <div class="muted" style="margin-top:6px">è‹¥æ™šæ–¼èµ·ç®—æ™‚é–“ï¼Œç³»çµ±å°‡ä¾è¦å‰‡è‡ªå‹•ä¼°ç®—é€¾æ™‚è²»ï¼š2å°æ™‚å…§æŒ‰å°æ™‚ï¼Œ2å°æ™‚ä»¥ä¸Šç‚ºåŠå¤©ï¼Œè¶…é12å°æ™‚ç‚ºä¸€å¤©ã€‚</div>
    </div>

    <!-- ç§Ÿå€Ÿæ—¥æœŸ/å¤©æ•¸è—åº•è³‡è¨Š -->
    <div id="summary" class="summary" aria-live="polite">
      ğŸ“¦ é ˜å–ï¼š<b id="pickup-date"></b><br />
      ğŸ“¦ æ­¸é‚„ï¼š<b id="return-date"></b><br />
      â° ç§Ÿå€Ÿå¤©æ•¸ï¼ˆ24hç‚ºä¸€æ—¥ï¼‰ï¼š<b id="rental-days"></b>
    </div>

    <div class="form-row">
      <label class="label" for="model">ç§Ÿå€Ÿè¨­å‚™ï¼ˆå¿…å¡«ï¼‰</label>
      <select class="control" id="model" name="model" required>
        <option value="" disabled selected>è«‹é¸æ“‡</option>
        <option value="S23 Ultra é»‘ 256G">Samsung Galaxy S23 Ultra é»‘ 256Gï¼ˆå·²è²¼ä¿è­·è²¼ï¼‰</option>
      </select>
    </div>

    <div class="form-row">
      <label class="label">åŠ å€¼é…ä»¶</label>
      <label class="checkbox" for="charger">
        <input type="checkbox" id="charger" name="charger" />
        <span>éœ€è¦ Type-C å……é›»é ­ï¼ˆå…è²»å€Ÿç”¨ï¼Œæ•¸é‡æœ‰é™ï¼Œè«‹å…ˆå‹¾é¸ç¢ºä¿æº–å‚™ï¼‰</span>
      </label>
      <label class="checkbox" for="usba">
        <input type="checkbox" id="usba" name="usba" />
        <span>éœ€è¦ USB-A â‡„ Type-C ç·šï¼ˆå¯æ›¿æ›åŸ Type-C â‡„ Type-Cï¼‰</span>
      </label>
    </div>

    <!-- ä»˜æ¬¾å¹£åˆ¥ -->
    <div class="form-row">
      <label class="label" for="currency">ä»˜æ¬¾å¹£åˆ¥ï¼ˆå¿…å¡«ï¼‰</label>
      <select class="control" id="currency" name="currency" required>
        <option value="" disabled selected>è«‹é¸æ“‡å¹£åˆ¥</option>
        <option value="TWD">å°å¹£</option>
        <option value="KRW">éŸ“å¹£</option>
      </select>
    </div>

    <!-- é ä¼°é‡‘é¡ï¼ˆè—åº•ï¼‰ -->
    <div id="priceSummary" class="summary" aria-live="polite" style="display:none"></div>

    <!-- è¯çµ¡æ–¹å¼ -->
    <div class="form-row">
      <label class="label" for="contactType">è¯çµ¡æ–¹å¼ï¼ˆå¿…å¡«ï¼‰</label>
      <div class="row-flex">
        <select id="contactType" name="contactType" class="control" style="flex:0.35" required>
          <option value="" disabled selected>é¸æ“‡æ–¹å¼</option>
          <option value="IG">IG</option>
          <option value="LINE">LINE</option>
        </select>
        <input type="text" id="contactId" name="contactId" class="control" style="flex:0.65"
               placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required autocomplete="new-password"/>
      </div>
    </div>

    <div class="form-row">
      <label class="label" for="pickup">é è¨ˆå–æ©Ÿåœ°é»ï¼ˆå¿…å¡«ï¼‰</label>
      <select class="control" id="pickup" name="pickup" required>
        <option value="" disabled selected>è«‹é¸æ“‡</option>
        <option>å¼˜å¤§ï¼ˆí™ëŒ€ï¼‰</option>
        <option>åˆäº•ï¼ˆí•©ì •ï¼‰</option>
        <option>ä¸Šæ°´ï¼ˆìƒìˆ˜ï¼‰</option>
        <option>ä¹è€æ•¸ç¢¼åœ’å€ï¼ˆêµ¬ë¡œë””ì§€í„¸ë‹¨ì§€ï¼‰</option>
        <option>å…¶ä»–ï¼ˆè«‹åœ¨å‚™è¨»å¡«å¯«ï¼‰</option>
      </select>
    </div>

    <div class="form-row">
      <label class="label" for="note">å‚™è¨»</label>
      <textarea class="control" id="note" name="note" placeholder="è‹¥éœ€ä¸åŒæ­¸é‚„æ—¥æœŸ/æ™‚é–“ã€ç‰¹æ®Šéœ€æ±‚ï¼ˆWater Bomb/é•·æ™‚æ‹æ”ï¼‰ã€æˆ–å…¶ä»–åœ°é»ï¼Œè«‹åœ¨æ­¤è£œå……" autocomplete="off"></textarea>
    </div>

    <div class="form-row">
      <label class="checkbox" for="agree">
        <input type="checkbox" id="agree" name="agree" required />
        <span>æˆ‘å·²é–±è®€ä¸¦åŒæ„<a href="#guide" class="kbd">ç§Ÿå€ŸæŒ‡å—</a>ï¼ˆå¿…å¡«ï¼‰</span>
      </label>
      <div class="muted">é€å‡ºä»£è¡¨åŒæ„ç§Ÿå€Ÿã€æŠ¼é‡‘ã€é€¾æ™‚èˆ‡è³ å„Ÿç›¸é—œè¦ç¯„ã€‚</div>
    </div>

    <div class="actions">
      <button id="submitBtn" type="submit">é€å‡ºé ç´„</button>
    </div>
  </form>

  <!-- å¯å±•é–‹çš„å®Œæ•´ç§Ÿå€ŸæŒ‡å—ï¼ˆç•¥ï¼‰ -->
  <details id="guide" class="guide">
    <summary>ğŸ“˜ ç§Ÿå€ŸæŒ‡å—ï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰</summary>
    <div class="hr"></div>
    <h3>ã€ç§Ÿå€Ÿè²»ç”¨é‡é»ã€‘</h3>
    <ul>
      <li>è¨ˆåƒ¹ä»¥ 24 å°æ™‚ç‚º 1 å¤©ï¼Œè‡ªå–æ©Ÿæ™‚é–“èµ·ç®—ï¼›é€¾æ™‚ 2 å°æ™‚å…§æŒ‰å°æ™‚è¨ˆï¼Œ2 å°æ™‚ä»¥ä¸ŠåŠå¤©ï¼Œè¶…é 12 å°æ™‚ç®— 1 å¤©ã€‚</li>
      <li>å°å¹£ï¼šæ¯å°æ™‚ NT$100ï¼Œä¸Šé™ NT$700/æ—¥ï¼›åŠå¤© NT$350ï¼›ä¸€å¤© NT$700ã€‚</li>
      <li>éŸ“å¹£ï¼šæ¯å°æ™‚ â‚©4,000ï¼Œä¸Šé™ â‚©32,000/æ—¥ï¼›åŠå¤© â‚©16,000ï¼›ä¸€å¤© â‚©32,000ã€‚</li>
    </ul>
    <!-- å…¶é¤˜æ¢æ¬¾å¯æ”¾ä½ åŸæ–‡ï¼ˆç•¥ï¼‰ -->
  </details>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // â˜… Apps Script ç«¯é»
    const API_BASE = "https://script.google.com/macros/s/AKfycbw96IKgRxbRIXhsHbaYArxV2jKJYTEcJh2EDp23To3x9mh38yXU_zocA7rCP-X-cH8O/exec";

    const $ = (id)=>document.getElementById(id);
    const summary = $("summary");
    const pickupEl = $("pickup-date");
    const returnEl = $("return-date");
    const daysEl = $("rental-days");
    const priceSummary = $("priceSummary");

    function depositOf(currency){ return currency === 'KRW' ? 120000 : 3000; }
    function currencySign(currency){ return currency === 'KRW' ? 'â‚©' : '$'; }
    function fmt(currency, n){ return currencySign(currency) + Number(n).toLocaleString(); }

    // æ—¥ç§Ÿåˆ†ç´š
    function unitPrice(currency, days){
      if (currency === 'TWD') {
        if (days >= 5) return 600;
        if (days <= 2) return 700;
        return 650;
      }
      if (currency === 'KRW') {
        if (days >= 5) return 28000;
        if (days <= 2) return 32000;
        return 30000;
      }
      return 0;
    }

    // é€¾æ™‚è¦å‰‡ï¼ˆä»¥ä½ çš„å…¬å‘Šç‚ºæº–ï¼›ä¸€å¤©é‡‘é¡ä½œç‚ºé€¾æ™‚ã€Œä¸€å¤©ã€è²»ç”¨èˆ‡ä¸Šé™ï¼‰
    const Overage = {
      TWD: { perHour: 100, halfDay: 350, perDay: 700 },
      KRW: { perHour: 4000, halfDay: 16000, perDay: 32000 }
    };

    (function tintRequired(){
      document.querySelectorAll('label,.label,h1,h2,h3,h4').forEach(el=>{
        el.innerHTML = el.innerHTML.replace(/ï¼ˆå¿…å¡«ï¼‰/g,'<span class="req">ï¼ˆå¿…å¡«ï¼‰</span>');
      });
    })();

    function toYMDLocal(d){
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function getWeekday(d){return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}

    // ä¾ã€Œå–æ©Ÿæ™‚é–“ã€è¨ˆç®— 24h ç‚ºä¸€æ—¥çš„å¤©æ•¸ï¼ˆceilï¼‰
    function daysBy24h(startDate, endDate, pickupTime) {
      const [hh, mm] = pickupTime.split(':').map(Number);
      const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), hh, mm || 0, 0);
      const end   = new Date(endDate.getFullYear(),   endDate.getMonth(),   endDate.getDate(),   hh, mm || 0, 0);
      const ms = end - start;
      if (ms <= 0) return { days: 0, startDT: start, endDT: end };
      const days = Math.ceil(ms / 86400000); // 24h ç‚ºä¸€æ—¥
      return { days, startDT: start, endDT: end };
    }

    // è¶…æ™‚è²»ç”¨ä¼°ç®—ï¼šä»¥ã€Œé‚„æ©Ÿæ—¥ã€çš„é‚„æ©Ÿæ™‚é–“ vs è¦åŠƒçš„çµæŸæ™‚é–“ï¼ˆåŒä¸€æ™‚åˆ»ï¼‰
    function calcOverage(currency, plannedEndDT, returnTimeStr){
      if (!returnTimeStr) return { hours:0, fee:0, rule:'none' };
      const [rh, rm] = returnTimeStr.split(':').map(Number);
      const actual = new Date(plannedEndDT.getFullYear(), plannedEndDT.getMonth(), plannedEndDT.getDate(), rh, rm || 0, 0);
      const diffMs = actual - plannedEndDT;
      if (diffMs <= 0) return { hours:0, fee:0, rule:'none' };

      // å‘ä¸Šå–æ•´åˆ°æ•´å°æ™‚
      const hours = Math.ceil(diffMs / 3600000);
      const cfg = Overage[currency] || Overage.TWD;

      if (hours <= 2){
        const fee = Math.min(hours * cfg.perHour, cfg.perDay); // ç†è«–ä¸Šä¸æœƒè¶…éï¼Œä½†ä¿éšª
        return { hours, fee, rule:'hourly' };
      } else if (hours > 2 && hours <= 12){
        return { hours, fee: cfg.halfDay, rule:'half' };
      } else { // > 12h
        return { hours, fee: cfg.perDay, rule:'day' };
      }
    }

    let disabledSet = new Set();

    async function init() {
      let disabledRanges = [];
      try{
        const r = await fetch(API_BASE + "?action=reserved", { cache: "no-store" });
        const ranges = await r.json();
        if (Array.isArray(ranges)) {
          disabledRanges = ranges.map(x => ({ from: x.start, to: x.end }));
          ranges.forEach(({start,end})=>{
            const s = new Date(start), e = new Date(end);
            const cur = new Date(s.getFullYear(), s.getMonth(), s.getDate());
            const last = new Date(e.getFullYear(), e.getMonth(), e.getDate());
            while (cur <= last) {
              disabledSet.add(toYMDLocal(cur));
              cur.setDate(cur.getDate()+1);
            }
          });
        }
      }catch(err){ console.warn("å–å¾—é ç´„å€é–“å¤±æ•—ï¼š", err); }

      flatpickr("#daterange", {
        mode:"range",
        minDate:"today",
        dateFormat:"Y-m-d",
        disable: disabledRanges,
        onChange: updateSummaries
      });

      // å–æ©Ÿæ™‚é–“ï¼ˆ24hï¼‰
      flatpickr("#pickupTime", {
        enableTime:true,
        noCalendar:true,
        time_24hr:true,
        dateFormat:"H:i",
        defaultHour: 20,
        defaultMinute: 0,
        onChange: () => {
          // è‹¥æœªæ‰‹å‹•è¨­å®šé‚„æ©Ÿæ™‚é–“ï¼Œè®“å®ƒè·Ÿè‘—èµ·ç®—æ™‚é–“èµ°
          const rt = $("returnTime")._flatpickr;
          if (rt && !rt._manuallyChanged){
            rt.setDate($("pickupTime").value, true);
          }
          updateSummaries();
        }
      });

      // é‚„æ©Ÿæ™‚é–“ï¼ˆå¯ä¸åŒæ–¼èµ·ç®—æ™‚é–“ï¼‰
      const rtPicker = flatpickr("#returnTime", {
        enableTime:true,
        noCalendar:true,
        time_24hr:true,
        dateFormat:"H:i",
        onOpen: () => { rtPicker._opened = true; },
        onChange: () => { rtPicker._manuallyChanged = true; updateSummaries(); }
      });

      // é è¨­æŠŠé‚„æ©Ÿæ™‚é–“è¨­ç‚ºèˆ‡å–æ©Ÿæ™‚é–“ç›¸åŒ
      setTimeout(()=>{ 
        const pt = $("pickupTime").value || "20:00";
        rtPicker.setDate(pt, true);
      }, 0);

      ["model","currency","charger","usba","contactType","contactId","pickup","note"].forEach(id=>{
        const el = $(id); if(el) el.addEventListener('change', updatePrice);
      });

      document.getElementById("rental-form").addEventListener("submit", onSubmit);
    }

    function getSelectedDates(){
      const fp = $("daterange")._flatpickr;
      const sel = fp?.selectedDates || [];
      return sel.length === 2 ? sel : null;
    }

    function updateSummaries(){
      const sel = getSelectedDates();
      const t = $("pickupTime").value;
      if(!sel || !t){
        document.getElementById("summary").style.display = "none";
        priceSummary.style.display = "none";
        priceSummary.innerHTML = "";
        return;
      }
      const [s, e] = sel;
      const result = daysBy24h(s, e, t);
      const d = result.days;

      document.getElementById("summary").style.display = "block";
      pickupEl.textContent = `${s.getFullYear()}/${s.getMonth()+1}/${s.getDate()} ${t}ï¼ˆ${getWeekday(s)}ï¼‰`;
      // é¡¯ç¤ºã€Œé‚„æ©Ÿæ—¥ + é è¨ˆé‚„æ©Ÿæ™‚é–“ã€
      const returnTime = $("returnTime").value || t;
      returnEl.textContent = `${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()} ${returnTime}ï¼ˆ${getWeekday(e)}ï¼‰`;
      daysEl.textContent = d > 0 ? `${d} å¤©` : "â€”";
      updatePrice();
    }

    function updatePrice(){
      const model = $("model").value;
      const currency = $("currency").value;
      const sel = getSelectedDates();
      const t = $("pickupTime").value;
      if(!model || !currency || !sel || !t){
        priceSummary.style.display='none'; priceSummary.innerHTML=''; return;
      }
      const [s,e] = sel;
      const { days, endDT } = daysBy24h(s, e, t);
      if (days <= 0){ priceSummary.style.display='none'; return; }

      const per = unitPrice(currency, days);
      const rentTotal = per * days;
      const deposit = depositOf(currency);
      const grand = rentTotal + deposit;

      // è¶…æ™‚ä¼°ç®—
      const returnTimeStr = $("returnTime").value || t;
      const over = calcOverage(currency, endDT, returnTimeStr);

      // è¦å‰‡æ–‡å­—
      const ruleMap = {
        none: 'ç„¡é€¾æ™‚',
        hourly: `2 å°æ™‚å…§ï¼ŒæŒ‰å°æ™‚è¨ˆï¼ˆ${currency==='KRW'?'â‚©4,000':'$100'}/å°æ™‚ï¼‰`,
        half: 'è¶…é 2 å°æ™‚ï¼Œä»¥åŠå¤©è¨ˆ',
        day: 'è¶…é 12 å°æ™‚ï¼Œä»¥ 1 å¤©è¨ˆ'
      };

      priceSummary.innerHTML = `
        ğŸ’° ç§Ÿé‡‘ç¸½é¡ï¼š<b>${fmt(currency, rentTotal)}</b><br>
        ğŸ”’ æŠ¼é‡‘ï¼š<b>${fmt(currency, deposit)}</b><br>
        ğŸ“Š ç¸½é¡ï¼ˆç§Ÿé‡‘+æŠ¼é‡‘ï¼‰ï¼š<b>${fmt(currency, grand)}</b><br>
        ï¼ˆ${days} å¤© Ã— æ¯æ—¥ <b>${fmt(currency, per)}</b>ï¼Œä»¥ <b>${t}</b> èµ·ç®— 24h/æ—¥ï¼‰<br>
        <hr style="border:none;border-top:1px solid #dbe3ff; margin:10px 0;">
        â° é ä¼°é€¾æ™‚è²»ï¼š<b>${fmt(currency, over.fee)}</b>ã€€<span class="muted">ï¼ˆ${ruleMap[over.rule]}ï¼›æ™š <b>${over.hours}</b> å°æ™‚ï¼‰</span><br>
        <span class="muted">â€» é€¾æ™‚è²»åƒ…ä¾›é ä¼°ï¼Œå¯¦éš›æ–¼æ­¸é‚„ç•¶æ—¥ä¾è¦å®šçµç®—ï¼Œä¸ä½µå…¥é ä»˜ç¸½é¡ã€‚</span>
      `;
      priceSummary.style.display = 'block';
    }

    async function onSubmit(e){
      e.preventDefault();
      const f = e.target;

      if(!f.name.value.trim()){ alert("è«‹è¼¸å…¥å§“å"); return; }
      if(!f.phone.checkValidity()){ alert("è«‹è¼¸å…¥æœ‰æ•ˆé›»è©±ï¼ˆè‡³å°‘ 6 ç¢¼ï¼Œå¯å« + - ( ) ç©ºç™½ï¼‰"); return; }
      const sel = getSelectedDates(); if(!sel){ alert("è«‹é¸æ“‡å®Œæ•´çš„ç§Ÿå€Ÿæ—¥æœŸå€é–“ï¼"); return; }
      if(!$("pickupTime").value){ alert("è«‹é¸æ“‡å–æ©Ÿæ™‚é–“ï¼ˆèµ·ç®—æ™‚é–“ï¼‰"); return; }
      if(!$("model").value){ alert("è«‹é¸æ“‡ç§Ÿå€Ÿè¨­å‚™ï¼"); return; }
      if(!$("currency").value){ alert("è«‹é¸æ“‡ä»˜æ¬¾å¹£åˆ¥ï¼"); return; }
      if(!$("contactType").value){ alert("è«‹é¸æ“‡è¯çµ¡æ–¹å¼ï¼ˆIG/LINEï¼‰"); return; }
      if(!$("contactId").value.trim()){ alert("è«‹è¼¸å…¥è¯çµ¡å¸³è™Ÿ"); return; }
      if(!$("pickup").value){ alert("è«‹é¸æ“‡å–æ©Ÿåœ°é»"); return; }
      if(!$("agree").checked){ alert("è«‹å…ˆå‹¾é¸ä¸¦åŒæ„ç§Ÿå€ŸæŒ‡å—ï¼"); return; }

      const [s,eDate] = sel;

      // æª¢æŸ¥æ˜¯å¦ç¢°æ’å·²é ç´„æ—¥ï¼ˆä»¥æ—¥æœŸç‚ºå–®ä½ï¼‰
      let cur = new Date(s.getFullYear(), s.getMonth(), s.getDate());
      const last = new Date(eDate.getFullYear(), eDate.getMonth(), eDate.getDate());
      while (cur <= last) {
        if (disabledSet.has(toYMDLocal(cur))) { alert(`âŒ é‡è¤‡æ—¥æœŸï¼š${toYMDLocal(cur)} å·²è¢«é ç´„ï¼Œè«‹æ”¹é¸å…¶ä»–æ—¥æœŸã€‚`); return; }
        cur.setDate(cur.getDate()+1);
      }

      const pickupTime = $("pickupTime").value;
      const returnTimeStr = $("returnTime").value || pickupTime;
      const { days, startDT, endDT } = daysBy24h(s, eDate, pickupTime);
      const currency = $("currency").value;
      const per = unitPrice(currency, days);
      const rentTotal = per * days;
      const deposit = depositOf(currency);
      const grand = rentTotal + deposit;

      const over = calcOverage(currency, endDT, returnTimeStr);

      const payload = {
        name: f.name.value.trim(),
        phone: f.phone.value.trim(),
        startDate: toYMDLocal(s),
        endDate: toYMDLocal(eDate),
        pickupTime,
        returnTime: returnTimeStr,
        startISO: startDT.toISOString(),
        plannedEndISO: endDT.toISOString(),
        estimatedOverageHours: over.hours,
        estimatedOverageFee: over.fee,
        estimatedOverageRule: over.rule,
        days: `${days} å¤©ï¼ˆ24h/æ—¥åˆ¶ï¼‰`,
        model: f.model.value,
        charger: f.charger?.checked ? "éœ€è¦" : "ä¸éœ€è¦",
        usba: f.usba?.checked ? "éœ€è¦" : "ä¸éœ€è¦",
        contactType: $("contactType").value,
        contactId: $("contactId").value.trim(),
        pickup: f.pickup.value,
        note: f.note.value.trim(),
        currency,
        dailyPrice: per,
        rentTotal,
        deposit,
        grandTotal: grand,
        agree: "yes",
        timestamp: new Date().toISOString(),
      };

      const btn = $("submitBtn"); const txt = btn.textContent;
      btn.disabled = true; btn.textContent = "é€å‡ºä¸­â€¦";

      try{
        const res = await fetch(API_BASE, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });
        const text = await res.text();
        let result; try{ result = JSON.parse(text); }catch{ alert("âŒ å¾Œç«¯ä¸æ˜¯ JSON å›æ‡‰ï¼š\n\n" + text.slice(0,500)); return; }
        if(result && (result.success === true || result.status === "success")){
          window.location.href = "thanks.html";
        }else{
          alert("âŒ é ç´„å¤±æ•—ï¼š" + ((result && (result.message || result.error)) || "æœªçŸ¥éŒ¯èª¤"));
        }
      }catch(err){
        alert("âŒ é€å‡ºå¤±æ•—ï¼š" + err.message);
      }finally{
        btn.disabled = false; btn.textContent = txt;
      }
    }

    init();
  </script>
</body>
</html>
